name: "Copilot Setup Steps"

# This workflow customizes the development environment for GitHub Copilot coding agent.
# The job name MUST be exactly "copilot-setup-steps" for Copilot to recognize it.
# Reference: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps: # This name is mandatory!
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read # Minimum required permission
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
      
      - name: Verify Flutter installation
        run: |
          flutter --version
          dart --version
      
      - name: Install Flutter dependencies
        run: flutter pub get
      
      # - name: Run code generation
      #   run: dart run build_runner build --delete-conflicting-outputs
      
      - name: Configure Gradle for CI
        run: |
          if [ -f android/gradle-ci.properties ]; then
            cp android/gradle-ci.properties android/gradle.properties
          fi
      
      - name: Pre-download Gradle dependencies
        working-directory: android
        run: ./gradlew --no-daemon dependencies || true
      
      - name: Install Android SDK components
        run: |
          # Use Flutter's bundled Android SDK or skip if not available
          if [ -n "$ANDROID_HOME" ] && [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
            $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          elif [ -n "$ANDROID_SDK_ROOT" ] && [ -f "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
            $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          else
            echo "Android SDK cmdline-tools not found, skipping SDK component installation"
            echo "Flutter doctor will handle basic Android SDK setup"
          fi
      
      - name: Verify environment
        run: |
          echo "=== Flutter Doctor ==="
          flutter doctor -v
          echo "=== Dart Analyze ==="
          flutter analyze --no-fatal-infos || true
          echo "=== Environment Ready ==="
